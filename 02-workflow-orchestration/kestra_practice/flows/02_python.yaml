id: 02_python
namespace: zoomcamp

description: This flow will install the pip package in a Docker container, and use kestra's Python library to generate outputs (number of downloads of the Kestra Docker image) and metrics (duration of the script).

tasks:
  - id: collect_stats
    type: io.kestra.plugin.scripts.python.Script # This tells Kestra: â€œRun a Python scriptâ€ Uses the Python Script plugin
    taskRunner:
      type: io.kestra.plugin.scripts.runner.docker.Docker # Explicitly tells Kestra: â€œRun this task inside a Docker containerâ€
    containerImage: python:slim # The Docker image to use for the container
    dependencies: # Kestra will: Install these pip packages inside the container before running the script
      - requests # The requests library to make HTTP requests
      - kestra # The Kestra Python SDK to interact with Kestra (e.g., to set outputs and metrics)
    script: |
      from kestra import Kestra
      import requests
      import json
      def get_docker_image_downloads(image_name: str = "kestra/kestra"):
          """Queries the Docker Hub API to get the number of downloads for a specific Docker image."""
          url = f"https://hub.docker.com/v2/repositories/{image_name}/"
          response = requests.get(url)
          data = response.json()

          # ğŸ‘‡ LOG RAW RESPONSE
          print("Docker Hub API response:")
          print(json.dumps(data, indent=2))

          downloads = data.get('pull_count', 'Not available')
          return downloads
      downloads = get_docker_image_downloads() # Get the number of downloads for the Kestra Docker image
      outputs = {
          'downloads': downloads
      }
      Kestra.outputs(outputs) # Set the outputs of the task (accessible in Kestra)
  